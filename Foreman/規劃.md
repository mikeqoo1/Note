# è¦åŠƒ Foreman æ¶æ§‹

```bash
[ Foreman Server ]
  â”œâ”€ Web UI (20443)
  â”œâ”€ PostgreSQL
  â”œâ”€ TFTP (PXE)
  â”œâ”€ DHCP (å¯å¤–æ›)
  â”œâ”€ DNS  (å¯å¤–æ›)
  â””â”€ Ansible (Remote Execution)
```

**ç¡¬é«”å»ºè­°**

| é …ç›®  | å»ºè­°                        |
| ---- | -------------------------  |
| OS   | Rocky Linux 10 / Alma 10   |
| CPU  | 4 coreï¼ˆå»ºè­° 8ï¼‰            |
| RAM  | **8G èµ·è·³ï¼ˆ16G èˆ’æœï¼‰**      |
| Disk | 100G+ |


# é–‹å§‹å®‰è£æ­¥é©Ÿ

[Enterprise Linux 9 ç‚ºä¾‹]((https://docs.pingcap.com/zh/tidb/dev/tiup-cluster-topology-reference))

Enable Puppet's 8.x repository:

```bash
sudo dnf -y install https://yum.puppet.com/puppet8-release-el-9.noarch.rpm
```

Enable the Foreman repositories:

```bash
sudo dnf -y install https://yum.theforeman.org/releases/3.17/el9/x86_64/foreman-release.rpm
```

Downloading the installer

```bash
sudo dnf -y install foreman-installer
```

Running the installer

```bash
sudo foreman-installer
```

![alt text](å•é¡Œ1.png)

å•é¡Œ1:éœ€è¦è¨­å®šhost

```bash
sudo hostnamectl set-hostname emts-rd-03.concords.com.tw
```

```bash
sudo vi /etc/hosts

192.168.x.x emts-rd-03.concords.com.tw EMRS-RD-03
```

![alt text](å•é¡Œ2.png)

å…ˆæŠŠ PostgreSQL server è£èµ·ä¾†ï¼Œè£œä¸Š initdbï¼ˆå°±ç®— installer å¾ŒçºŒæœƒè£ï¼Œä½ å…ˆè£œé½Šï¼Œé¿å…å®ƒä¸€ç›´å¡ï¼‰

```bash
sudo dnf -y install postgresql postgresql-server
command -v initdb
ls -l /usr/bin/initdb
```

command -v initdb å¿…é ˆè¦å› /usr/bin/initdb æ‰ç®—éé—œã€‚

è¨˜å¾—é–‹443çš„é˜²ç«ç‰†ç„¶å¾Œç›´æ¥åœ¨ç€è¦½å™¨ä¸Šhttps://192.168.199.236

å°±å¯ä»¥é€²åˆ°ç™»å…¥ç•«é¢äº†

Initial credentials are admin / LbdjQn8dJbXz8CqA

ç™»å…¥å¾Œé•·é€™æ¨£

![alt text](ä¸»é é¢.png)

# Foreman â†’ Ansible æ§åˆ¶å°

Step 1 â€” ç¢ºèª Ansible Plugin æœ‰è£

```bash
rpm -qa | grep foreman-plugin-ansible

æ²’æœ‰è¼¸å‡ºæ±è¥¿çš„è©±å°±å®‰è£

sudo dnf install -y foreman-plugin-ansible

å•Ÿç”¨ansible

sudo foreman-installer --enable-foreman-plugin-ansible
```

Step 2 â€” å•Ÿç”¨ Remote Execution

```bash
sudo foreman-installer \
  --enable-foreman-plugin-remote-execution \
  --enable-foreman-proxy-plugin-remote-execution-script
```

Step 3 â€” å»ºç«‹ foreman-proxy çš„ SSH é‡‘é‘°

åœ¨ Foreman ä¸»æ©Ÿä¸ŠåŸ·è¡Œï¼š

```bash
sudo -u foreman-proxy mkdir -p ~foreman-proxy/.ssh
sudo -u foreman-proxy ssh-keygen -t ed25519 -N "" -f ~foreman-proxy/.ssh/id_ed25519
```

ç„¶å¾Œï¼š

```bash
sudo -u foreman-proxy cat ~foreman-proxy/.ssh/id_ed25519.pub
```

æŠŠé‚£ä¸€æ•´è¡Œè¤‡è£½èµ·ä¾†ã€‚

ğŸ§± Step 4 â€” æŠŠé‡‘é‘°åŠ åˆ°è¢«æ§ä¸»æ©Ÿ

å› ç‚ºä½ ç¾åœ¨æ˜¯ã€Œè‡ªå·±æ§è‡ªå·±ã€æ¸¬è©¦ï¼š

```bash
sudo mkdir -p /root/.ssh
sudo vi /root/.ssh/authorized_keys
```

æŠŠå‰›å‰›é‚£è¡Œè²¼é€²å»ã€‚

ç„¶å¾Œï¼š

```bash
sudo chmod 700 /root/.ssh
sudo chmod 600 /root/.ssh/authorized_keys
```

ğŸ§ª Step 5 â€” æ¸¬è©¦ SSH æ˜¯å¦æˆåŠŸ

é€™ä¸€æ­¥ä¸€å®šè¦éï¼š

```bash
sudo -u foreman-proxy ssh -o StrictHostKeyChecking=accept-new root@192.168.199.236 "whoami"
```

å¦‚æœæˆåŠŸæœƒè¼¸å‡ºï¼š
root

è¨­å®šæª”è¦æ›´æ–°

sudo vi /etc/foreman-proxy/settings.d/remote_execution_ssh.yml

![alt text](è¨­å®šæª”.png)

é€™å€‹è¦æ›æˆ ~foreman-proxy/.ssh/id_ed25519

ç„¶å¾Œé‡æ–°å•Ÿå‹•æœå‹™

```bash
sudo systemctl restart foreman-proxy
```

ğŸ§  Step 6 â€” UI è¨­å®š Host

UIï¼š
  1. Hosts â†’ All Hosts
  2. é» emts-rd-03â€¦
  3. Edit
  4. æ‰¾ Parameters
æ–°å¢ï¼š

```bash
remote_execution_connect_by_ip = true
remote_execution_ssh_user = root
```

![alt text](åƒæ•¸è¨­å®š.png)

